<!DOCTYPE html>
<html>
<head>
  <title>AgriPrice Pro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    div.main {
      padding: 5px 50px 75px 50px;
    }
    canvas {
      background: #fff;
      border: 1px solid #ddd;
      margin-bottom: 25px;
      height: 400px !important;
      width: 100% !important;
    }
    .highlight-max {
      borderColor: "rgb(0, 200, 0)";
    }
    .highlight-min {
      borderColor: "rgb(200, 0, 0)";
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="nav-wrapper">
      <h3 class="card-panel amber lighten-2 center valign-wrapper center">
        <a class="brand-logo text-lighten-4" href="#">
          <img alt="" src="/static/ApnaAnaajLogo.png" height="100px" width="100px" class="responsive-img" />
          <span>AgriPrice Pro</span>
        </a>
      </h3>
    </div>

    <h2 class="header">{{context.name}}</h2>

    <div class="row">
      <div class="col s8 m7">
        <div class="card horizontal medium">
          <div class="card-image">
            <img src="{{context.image_url}}">
          </div>
          <div class="card-stacked">
            <div class="card-content">
              <table>
                <tr><td>Current Price</td><td><b>₹ {{context.current_price}} / ql</b></td></tr>
                <tr><td>Prime Location</td><td><b>{{context.prime_loc}}</b></td></tr>
                <tr><td>Crop Type</td><td><b>{{context.type_c}}</b></td></tr>
                <tr><td>Export</td><td><b>{{context.export}}</b></td></tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col s4">
        <div class="card grey lighten-3">
          <div class="card-content black-text">
            <span class="card-title">Brief Forecast</span>
            <table>
              <tr>
                <td><p>Min. crop price time</p></td>
                <td><h5>{{context.min_crop[0]}}</h5></td>
                <td><h4>₹{{context.min_crop[1]}}</h4></td>
              </tr>
              <tr>
                <td><p>Max. crop price time</p></td>
                <td><h5>{{context.max_crop[0]}}</h5></td>
                <td><h4>₹{{context.max_crop[1]}}</h4></td>
              </tr>
            </table>
          </div>       
        </div>
      </div>
    </div>
  </div>

  <div class="row">    
    <div class="col s4">
      <h5>Forecast Trends</h5>
      <table class="striped">
        <thead>
          <tr><th>Month</th><th>Price (per Qtl.)</th><th>Change</th></tr>
        </thead>
        <tbody>
        {% for item in context.forecast_values %}
          <tr>
            <td>{{item[0]}}</td>
            <td>₹{{item[1]}}</td>
            <td class="valign-wrapper">
              {{item[2]}}% 
              {% if item[2]>=0 %}
                <img src="../static/gain-icon.png" height="25" width="25">
              {% else %}
                <img src="../static/loss-icon.png" height="25" width="25">
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="col s8">
      <h5>Forecast vs Previous Year</h5>
      <canvas id="chartjs-forecast"></canvas>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
  <script>
    // Convert Jinja context arrays to JS arrays
    const months = {{ context.forecast_x | tojson }};
    const forecastPrices = {{ context.forecast_y | tojson }};
    const previousPrices = {{ context.previous_y | tojson }};

    // Helper to highlight max and min points
    function getPointStyles(data) {
      const max = Math.max(...data);
      const min = Math.min(...data);
      return data.map(value => {
        if (value === max) return { radius: 8, backgroundColor: 'green' };
        if (value === min) return { radius: 8, backgroundColor: 'red' };
        return { radius: 4, backgroundColor: 'blue' };
      });
    }

    new Chart(document.getElementById("chartjs-forecast"), {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Previous Year Price',
            data: previousPrices,
            borderColor: 'rgb(255, 99, 132)',
            fill: false,
            pointBackgroundColor: getPointStyles(previousPrices).map(p => p.backgroundColor),
            pointRadius: getPointStyles(previousPrices).map(p => p.radius)
          },
          {
            label: 'Forecast Price',
            data: forecastPrices,
            borderColor: 'rgb(54, 162, 235)',
            fill: false,
            pointBackgroundColor: getPointStyles(forecastPrices).map(p => p.backgroundColor),
            pointRadius: getPointStyles(forecastPrices).map(p => p.radius)
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: false
            },
            scaleLabel: {
              display: true,
              labelString: 'Price (₹/Qtl)'
            }
          }],
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Month'
            }
          }]
        }
      }
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
